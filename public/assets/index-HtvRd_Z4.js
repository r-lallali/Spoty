import{r as i,j as e,l as te,A as n,C as v,B as E,ab as re,ac as se,ad as oe}from"./index-DdlObs6W.js";import{b as ie,c as U,d as ne,e as le}from"./index-CkrcthVr.js";import{T as o}from"./index-_MCSnTcs.js";import{I as H}from"./image-ChmrOsv1.js";import{H as O,V as M,F as ae}from"./v-stack-DhS3kTGh.js";const q=i.forwardRef(function(t,d){const{templateAreas:l,column:r,row:x,autoFlow:u,autoRows:s,templateRows:y,autoColumns:p,templateColumns:g,inline:S,...f}=t;return e.jsx(te.div,{...f,ref:d,css:[{display:S?"inline-grid":"grid",gridTemplateAreas:l,gridAutoColumns:p,gridColumn:r,gridRow:x,gridAutoFlow:u,gridAutoRows:s,gridTemplateRows:y,gridTemplateColumns:g},t.css]})});q.displayName="Grid";function ce({playlists:j,selectedPlaylist:t,onSelectPlaylist:d,onStartGame:l,loading:r,isPlayerReady:x,playerError:u}){return e.jsxs(n,{children:[e.jsx(o,{fontSize:"4xl",fontWeight:"bold",color:"spotify.white",children:"Blind Test"}),e.jsx(o,{fontSize:"md",fontWeight:"normal",color:"spotify.lightGray",children:"Testez vos connaissances musicales en devinant les morceaux"}),e.jsxs(n,{position:"relative",minH:"70vh",mt:6,children:[e.jsx(o,{fontSize:"lg",fontWeight:"semibold",color:"white",mb:4,children:"Mes playlists"}),r?e.jsx(v,{py:10,children:e.jsx(o,{color:"#b3b3b3",children:"Chargement..."})}):e.jsxs(e.Fragment,{children:[e.jsx(q,{templateColumns:"repeat(auto-fill, minmax(100px, 1fr))",gap:4,mb:8,children:j.map(s=>e.jsxs(n,{cursor:"pointer",onClick:()=>d(s),position:"relative",transition:"transform 0.2s",_hover:{transform:"scale(1.05)"},children:[e.jsx(H,{src:s.images[0]?.url||"/placeholder.png",alt:s.name,borderRadius:"md",w:"100%",aspectRatio:1,objectFit:"cover"}),t?.id===s.id&&e.jsx(v,{position:"absolute",bottom:2,right:2,w:6,h:6,bg:"#1db954",borderRadius:"full",children:e.jsx(ie,{size:12,color:"black"})}),e.jsx(o,{color:"white",fontSize:"sm",mt:2,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:s.name})]},s.id))}),e.jsxs(E,{onClick:l,disabled:!t||r||!x,bg:"white",color:"black",borderRadius:"full",px:6,py:5,fontWeight:"semibold",fontSize:"sm",_hover:{bg:"gray.100"},_disabled:{opacity:.5,cursor:"not-allowed",bg:"gray.400"},children:[e.jsx(U,{style:{marginRight:10},size:12}),r?"Chargement...":x?"Commencer le Blind Test":"Lecteur non prÃªt"]})]}),u&&e.jsx(n,{position:"absolute",top:0,left:0,right:0,bottom:0,bg:"#121111ff",backdropFilter:"blur(16px)",zIndex:100,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"lg",children:e.jsxs(n,{bg:"#181818",borderRadius:"xl",p:8,maxW:"400px",mx:4,textAlign:"center",boxShadow:"2xl",children:[e.jsx(v,{w:16,h:16,bg:"whiteAlpha.100",borderRadius:"full",mx:"auto",mb:5,children:e.jsx(ne,{size:28,color:"#b3b3b3"})}),e.jsx(o,{fontSize:"xl",fontWeight:"bold",color:"white",mb:3,children:"Compte Premium requis"}),e.jsx(o,{color:"#b3b3b3",fontSize:"sm",children:"Le Blind Test nÃ©cessite un abonnement Spotify Premium pour lire les morceaux."})]})})]})]})}function de({playlistName:j,questions:t,currentQuestionIndex:d,score:l,timeLeft:r,timePerQuestion:x,answered:u,selectedAnswer:s,onAnswer:y,onReset:p}){const g=t[d];if(!g)return null;const S=r/x*100;return e.jsxs(n,{children:[e.jsxs(O,{justify:"space-between",mb:8,children:[e.jsx(n,{flex:1,children:e.jsx(E,{onClick:p,bg:"transparent",color:"#b3b3b3",p:2,_hover:{color:"white"},children:e.jsx(le,{size:24})})}),e.jsx(o,{fontSize:"xl",fontWeight:"bold",color:"white",textAlign:"center",children:j}),e.jsxs(M,{gap:1,align:"flex-end",flex:1,children:[e.jsxs(o,{fontWeight:"bold",color:"white",fontSize:"sm",children:[d+1,"/",t.length]}),e.jsx(n,{w:"80px",h:"15px",bg:"whiteAlpha.300",overflow:"hidden",children:e.jsx(n,{h:"100%",w:`${(d+1)/t.length*100}%`,bg:"white",transition:"width 0.3s ease"})})]})]}),e.jsxs(v,{flexDirection:"column",mb:8,children:[e.jsxs(n,{position:"relative",w:"180px",h:"180px",mb:4,children:[e.jsxs("svg",{width:"180",height:"180",viewBox:"0 0 180 180",children:[e.jsx("circle",{cx:"90",cy:"90",r:"80",fill:"none",stroke:"#000000ff",strokeWidth:"10"}),e.jsx("circle",{cx:"90",cy:"90",r:"80",fill:"none",stroke:"#1db954",strokeWidth:"11",strokeDasharray:`${2*Math.PI*80}`,strokeDashoffset:`${2*Math.PI*80*(1-S/100)}`,transform:"rotate(-90 90 90)",strokeLinecap:"square",style:{transition:"stroke-dashoffset 1s linear"}})]}),e.jsx(v,{position:"absolute",top:0,left:0,right:0,bottom:0,children:e.jsx(o,{fontSize:"6xl",fontWeight:"bold",color:"white",children:r})})]}),e.jsx(n,{bg:"white",borderRadius:"lg",px:4,py:3,children:e.jsxs(o,{fontSize:"2xl",fontWeight:"bold",color:"#121212",children:[l,"pt",l>2&&"s"]})})]}),e.jsx(M,{gap:3,maxW:"500px",mx:"auto",children:g.choices.map(f=>{const C=f.id===g.correctTrack.id,T=s?.id===f.id;let R="whiteAlpha.100",w="transparent";return u&&(C?(R="rgba(29, 185, 84, 0.4)",w="#1db954"):T&&(R="rgba(239, 68, 68, 0.4)",w="#ef4444")),e.jsx(E,{onClick:()=>y(f),disabled:u,w:"100%",py:6,bg:R,color:"white",border:"2px solid",borderColor:w,borderRadius:"lg",_hover:{bg:u?R:"whiteAlpha.200"},_disabled:{cursor:"default",opacity:C?1:.5},transition:"all 0.3s ease",children:f.name},f.id)})})]})}function ue({score:j,playlistName:t,playedTracks:d,onPlayAgain:l}){return e.jsxs(n,{children:[e.jsxs(ae,{bg:"#1db954",borderRadius:"lg",p:4,mb:8,justify:"space-between",align:"center",children:[e.jsx(n,{bg:"white",borderRadius:"md",px:4,py:2,children:e.jsxs(o,{fontSize:"xl",fontWeight:"bold",color:"#121212",children:[j,"pts"]})}),e.jsx(o,{fontSize:"xl",fontWeight:"bold",color:"#121212",children:t})]}),e.jsx(o,{fontSize:"lg",fontWeight:"semibold",color:"white",mb:4,children:"Morceaux jouÃ©s"}),e.jsx(M,{gap:3,align:"stretch",mb:8,children:d.map(({track:r,wasCorrect:x},u)=>e.jsxs(O,{bg:x?"rgba(29, 185, 84, 0.2)":"whiteAlpha.50",borderRadius:"lg",p:3,gap:4,children:[e.jsx(H,{src:r.album.images[0]?.url,alt:r.name,w:"50px",h:"50px",borderRadius:"md",objectFit:"cover"}),e.jsxs(n,{flex:1,children:[e.jsx(o,{color:"white",fontWeight:"medium",children:r.name}),e.jsx(o,{color:"#b3b3b3",fontSize:"sm",children:r.artists.map(s=>s.name).join(", ")})]})]},`${r.id}-${u}`))}),e.jsx(v,{children:e.jsxs(E,{onClick:l,bg:"white",color:"black",borderRadius:"full",px:6,py:5,fontWeight:"semibold",fontSize:"sm",_hover:{bg:"gray.100"},children:[e.jsx(U,{style:{marginRight:10},size:12}),"Rejouer"]})})]})}const he=10,W=30;function be(){const{playlists:j}=re.useLoaderData(),[t,d]=i.useState("setup"),[l,r]=i.useState(null),[x,u]=i.useState(!1),[s,y]=i.useState([]),[p,g]=i.useState(0),[S,f]=i.useState(0),[C,T]=i.useState(W),[R,w]=i.useState([]),[z,I]=i.useState(!1),[V,Q]=i.useState(null),b=i.useRef(null),{isReady:P,error:F,play:L,pause:A,activatePlayer:K,reconnect:$}=se();i.useEffect(()=>{!P&&!F&&(console.log("ðŸ”„ BlindTest: Player not ready, attempting reconnect..."),$())},[P,F,$]),i.useEffect(()=>{if(!(t!=="playing"||z))return b.current=setInterval(()=>{T(a=>a<=1?(clearInterval(b.current),setTimeout(()=>{z||D(null)},0),0):a-1)},1e3),()=>{b.current&&clearInterval(b.current)}},[t,z,p]);const _=a=>{const c=[...a];for(let h=c.length-1;h>0;h--){const m=Math.floor(Math.random()*(h+1));[c[h],c[m]]=[c[m],c[h]]}return c},Y=async()=>{if(l){if(!P){alert("Le lecteur Spotify n'est pas prÃªt. Assurez-vous d'avoir un compte Premium et que le SDK est chargÃ©.");return}await K(),u(!0);try{const a=await oe(l.id);if(a.length<4){alert("Cette playlist n'a pas assez de morceaux."),u(!1);return}const c=_(a),h=[];for(let B=0;B<Math.min(he,c.length);B++){const G=c[B],X=_(c.filter(ee=>ee.id!==G.id)).slice(0,3),Z=_([G,...X]);h.push({correctTrack:G,choices:Z})}y(h),g(0),f(0),T(W),w([]),I(!1),d("playing");const m=`spotify:track:${h[0].correctTrack.id}`;await L(m)||console.error("Failed to start first track")}catch(a){console.error("Error starting game:",a),alert("Erreur lors du dÃ©marrage du jeu.")}finally{u(!1)}}},D=async a=>{I(!0),b.current&&clearInterval(b.current),await A();const c=s[p];if(!c)return;const h=a?.id===c.correctTrack.id;if(h){const m=Math.floor(C/3);f(k=>k+3+m)}w(m=>[...m,{track:c.correctTrack,wasCorrect:h}]),setTimeout(async()=>{if(p<s.length-1){g(k=>k+1),T(W),I(!1),Q(null);const m=s[p+1];if(m){const k=`spotify:track:${m.correctTrack.id}`;await L(k)}}else await A(),d("results")},1500)},J=a=>{z||(Q(a),D(a))},N=async()=>{await A(),d("setup"),r(null),y([]),g(0),f(0),w([])};return i.useEffect(()=>()=>{A(),b.current&&(clearInterval(b.current),b.current=null)},[A]),e.jsxs(n,{p:8,height:"100%",position:"relative",overflowY:"auto",css:{"&::-webkit-scrollbar":{display:"none"},scrollbarWidth:"none"},children:[t==="setup"&&e.jsx(ce,{playlists:j,selectedPlaylist:l,onSelectPlaylist:r,onStartGame:Y,loading:x,isPlayerReady:P,playerError:!!F}),t==="playing"&&e.jsx(de,{playlistName:l?.name||"",questions:s,currentQuestionIndex:p,score:S,timeLeft:C,timePerQuestion:W,answered:z,selectedAnswer:V,onAnswer:J,onReset:N}),t==="results"&&e.jsx(ue,{score:S,playlistName:l?.name||"",playedTracks:R,onPlayAgain:N})]})}export{be as component};
